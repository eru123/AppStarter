<Window x:Class="AppStarter.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:AppStarter.ViewModels"
        xmlns:models="clr-namespace:AppStarter.Models"
        xmlns:converters="clr-namespace:AppStarter.Converters"
        Title="AppStarter - Process Manager" 
        Height="600" Width="800"
        MinHeight="400" MinWidth="500"
        Background="{StaticResource BackgroundBrush}"
        WindowStartupLocation="CenterScreen"
        SizeChanged="Window_SizeChanged"
        Style="{StaticResource CustomWindowStyle}">
    
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>
    
    <Window.Resources>
        <converters:StatusToColorConverter x:Key="StatusToColorConverter"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:EnumToBoolConverter x:Key="EnumToBoolConverter"/>

        <!-- Custom Menu Style -->
        <Style x:Key="ThemedMenuItem" TargetType="{x:Type MenuItem}">
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="Background" Value="{StaticResource SurfaceBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type MenuItem}">
                        <Border x:Name="Border" Background="{TemplateBinding Background}" Padding="12,8" CornerRadius="4" Margin="2,1">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" SharedSizeGroup="Icon"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <ContentPresenter x:Name="Icon" ContentSource="Icon" Margin="0,0,12,0" VerticalAlignment="Center"/>
                                <ContentPresenter Grid.Column="1" ContentSource="Header" VerticalAlignment="Center"/>
                                <Popup x:Name="Popup" Placement="Right" IsOpen="{TemplateBinding IsSubmenuOpen}" AllowsTransparency="True" Focusable="False" PopupAnimation="Fade">
                                    <Border Background="{StaticResource SurfaceBrush}" BorderBrush="{StaticResource SurfaceHoverBrush}" BorderThickness="1" CornerRadius="4" Padding="2" Margin="4,0,0,0">
                                        <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle"/>
                                    </Border>
                                </Popup>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="Role" Value="TopLevelHeader">
                                <Setter TargetName="Border" Property="Background" Value="Transparent"/>
                                <Setter TargetName="Border" Property="Padding" Value="6"/>
                            </Trigger>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="{StaticResource SurfaceHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Command Card Template -->
        <DataTemplate x:Key="CommandCardTemplate" DataType="{x:Type models:CommandConfig}">
            <Border Background="{StaticResource SurfaceBrush}" 
                    CornerRadius="8" 
                    Margin="0,0,0,4"
                    Padding="12"
                    Cursor="Hand">
                <Border.Style>
                    <Style TargetType="Border">
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{StaticResource SurfaceHoverBrush}"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Status Indicator -->
                    <Ellipse Grid.Column="0" Width="10" Height="10" 
                             Margin="0,0,12,0" VerticalAlignment="Center"
                             Fill="{Binding Status, Converter={StaticResource StatusToColorConverter}}"/>
                    
                    <!-- Command Info -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Name}" 
                                   Foreground="{StaticResource TextPrimaryBrush}"
                                   FontSize="15" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding Command}" 
                                   Foreground="{StaticResource TextMutedBrush}"
                                   FontSize="11" Margin="0,2,0,0"
                                   TextTrimming="CharacterEllipsis"/>
                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                            <Border Background="{StaticResource BackgroundBrush}" CornerRadius="3" Padding="6,2" Margin="0,0,6,0">
                                <TextBlock Text="{Binding Status}" 
                                           Foreground="{StaticResource TextSecondaryBrush}"
                                           FontSize="10" FontWeight="Medium"/>
                            </Border>
                            <Border Background="{StaticResource BackgroundBrush}" CornerRadius="3" Padding="6,2">
                                <TextBlock Text="{Binding RestartPolicy}" 
                                           Foreground="{StaticResource TextMutedBrush}"
                                           FontSize="10"/>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                    
                    <!-- Actions Menu -->
                    <Menu Grid.Column="2" VerticalAlignment="Center" Background="Transparent">
                        <MenuItem Style="{StaticResource ThemedMenuItem}">
                            <MenuItem.Header>
                                <Grid Width="24" Height="24">
                                    <TextBlock Text="⋮" FontSize="18" FontWeight="Bold" 
                                               HorizontalAlignment="Center" VerticalAlignment="Center"
                                               Foreground="{StaticResource TextSecondaryBrush}"/>
                                </Grid>
                            </MenuItem.Header>
                            
                            <!-- Menu Items -->
                            <MenuItem Header="Details" Style="{StaticResource ThemedMenuItem}"
                                      Command="{Binding DataContext.ViewDetailsCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                      CommandParameter="{Binding}">
                                <MenuItem.Icon>
                                    <TextBlock Text="ℹ" FontSize="14" HorizontalAlignment="Center" Foreground="{StaticResource TextSecondaryBrush}"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="Start" Style="{StaticResource ThemedMenuItem}"
                                      Command="{Binding DataContext.StartCommandCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                      CommandParameter="{Binding}"
                                      Visibility="{Binding Status, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Stopped}">
                                <MenuItem.Icon>
                                    <TextBlock Text="▶" FontSize="14" HorizontalAlignment="Center" Foreground="{StaticResource SuccessBrush}"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="Stop" Style="{StaticResource ThemedMenuItem}"
                                      Command="{Binding DataContext.StopCommandCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                      CommandParameter="{Binding}"
                                      Visibility="{Binding Status, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Running}">
                                <MenuItem.Icon>
                                    <TextBlock Text="■" FontSize="14" HorizontalAlignment="Center" Foreground="{StaticResource DangerBrush}"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="Restart" Style="{StaticResource ThemedMenuItem}"
                                      Command="{Binding DataContext.RestartCommandCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                      CommandParameter="{Binding}">
                                <MenuItem.Icon>
                                    <TextBlock Text="↻" FontSize="14" HorizontalAlignment="Center" Foreground="{StaticResource TextSecondaryBrush}"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="Edit" Style="{StaticResource ThemedMenuItem}"
                                      Command="{Binding DataContext.EditCommandCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                      CommandParameter="{Binding}">
                                <MenuItem.Icon>
                                    <TextBlock Text="✎" FontSize="14" HorizontalAlignment="Center" Foreground="{StaticResource TextSecondaryBrush}"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator Background="{StaticResource BackgroundBrush}" Height="1" Margin="0,2"/>
                            <MenuItem Header="Duplicate" Style="{StaticResource ThemedMenuItem}"
                                      Command="{Binding DataContext.DuplicateCommandCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                      CommandParameter="{Binding}">
                                <MenuItem.Icon>
                                    <TextBlock Text="❐" FontSize="14" HorizontalAlignment="Center" Foreground="{StaticResource TextSecondaryBrush}"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="Delete" Style="{StaticResource ThemedMenuItem}"
                                      Command="{Binding DataContext.DeleteCommandCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                      CommandParameter="{Binding}"
                                      Foreground="{StaticResource DangerBrush}">
                                <MenuItem.Icon>
                                    <TextBlock Text="🗑" FontSize="14" HorizontalAlignment="Center" Foreground="{StaticResource DangerBrush}"/>
                                </MenuItem.Icon>
                            </MenuItem>
                        </MenuItem>
                    </Menu>
                </Grid>
            </Border>
        </DataTemplate>
        
        
        <!-- LogEntryTemplate moved to App.xaml -->
    </Window.Resources>
    
    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Main Menu -->
        <Menu Grid.Row="0" Background="{StaticResource SurfaceBrush}" Padding="4">
            <MenuItem Header="File">
                <MenuItem Header="Exit" Click="Exit_Click"/>
            </MenuItem>
            <!--
            <MenuItem Header="Edit" Visibility="Collapsed">
                 <MenuItem Header="Settings (Todo)" />
            </MenuItem>
            -->
            <MenuItem Header="View">
                <MenuItem Header="Toggle Logs" Click="ToggleLogs_Click"/>
            </MenuItem>
            <MenuItem Header="Help">
                <MenuItem Header="About" Click="About_Click"/>
            </MenuItem>
        </Menu>
        
        <!-- Header -->
        <Grid Grid.Row="1" Margin="0,8,0,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <StackPanel Grid.Column="0">
                <TextBlock Text="⚡ AppStarter" 
                           Foreground="{StaticResource TextPrimaryBrush}"
                           FontSize="20" FontWeight="Bold"/>
                <TextBlock Text="Commands Process Manager" 
                           Foreground="{StaticResource TextSecondaryBrush}"
                           FontSize="12" Margin="0,2,0,0"/>
            </StackPanel>
            
            <!-- Service Status -->
            <Border Grid.Column="1" 
                    Background="{StaticResource SurfaceBrush}" 
                    CornerRadius="8" Padding="12,6">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Service: " 
                               Foreground="{StaticResource TextSecondaryBrush}"
                               VerticalAlignment="Center" FontSize="12"/>
                    <TextBlock Text="{Binding ServiceStatus}" 
                               Foreground="{StaticResource AccentBrush}"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center" Margin="0,0,12,0" FontSize="12"/>
                    
                    <Button Content="Install" Style="{StaticResource PrimaryButton}"
                            Command="{Binding InstallServiceCommand}"
                            Visibility="{Binding IsInstallServiceVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                            Padding="8,4" Margin="0,0,8,0" FontSize="12"/>
                    
                    <Button Content="Uninstall" Style="{StaticResource DangerButton}"
                            Command="{Binding UninstallServiceCommand}"
                            Visibility="{Binding IsUninstallServiceVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                            Padding="8,4" FontSize="12"/>
                </StackPanel>
            </Border>
        </Grid>
        
        <!-- Main Content -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="2*" MinHeight="200"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition x:Name="LogsRow" Height="*" MinHeight="150"/>
            </Grid.RowDefinitions>
            
            <!-- Top Panel - Command List -->
            <Border Grid.Row="0" 
                    Background="{StaticResource SurfaceBrush}" 
                    CornerRadius="8" Padding="8">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Panel Header with Actions -->
                    <Grid Grid.Row="0" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" Text="Commands" 
                                   Foreground="{StaticResource TextPrimaryBrush}"
                                   FontSize="14" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        
                        <!-- Bulk Actions & Add Button -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal">
                            <Button x:Name="LogsButton" Content="📋 Logs" 
                                    Style="{StaticResource SecondaryButton}"
                                    Click="LogsButton_Click"
                                    Visibility="Collapsed"
                                    Padding="10,4" Margin="0,0,8,0" FontSize="11"/>
                            <Button Content="▶ All" 
                                    Style="{StaticResource SuccessButton}"
                                    Command="{Binding StartAllCommandsCommand}"
                                    Padding="10,4" Margin="0,0,8,0" FontSize="11"/>
                            <Button Content="■ All" 
                                    Style="{StaticResource DangerButton}"
                                    Command="{Binding StopAllCommandsCommand}"
                                    Padding="10,4" Margin="0,0,8,0" FontSize="11"/>
                            <Button Content="+ Add" 
                                    Style="{StaticResource PrimaryButton}"
                                    Command="{Binding AddCommandCommand}"
                                    Padding="12,4" FontSize="12"/>
                        </StackPanel>
                    </Grid>
                    
                    <!-- Search -->
                    <TextBox Grid.Row="1" 
                             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                             Margin="0,0,0,10" Padding="8,6" FontSize="12"
                             BorderThickness="0" Background="{StaticResource BackgroundBrush}"
                             Foreground="{StaticResource TextPrimaryBrush}">
                        <TextBox.Resources>
                            <Style TargetType="{x:Type Border}">
                                <Setter Property="CornerRadius" Value="6"/>
                            </Style>
                        </TextBox.Resources>
                        <TextBox.Style>
                            <Style TargetType="TextBox" BasedOn="{StaticResource {x:Type TextBox}}">
                                <Style.Triggers>
                                    <Trigger Property="Text" Value="">
                                        <Setter Property="Background">
                                            <Setter.Value>
                                                <VisualBrush Stretch="None" AlignmentX="Left">
                                                    <VisualBrush.Visual>
                                                        <TextBlock Text="🔍 Search commands..." 
                                                                   Foreground="{StaticResource TextMutedBrush}"
                                                                   Margin="10,6,0,0" FontSize="12"/>
                                                    </VisualBrush.Visual>
                                                </VisualBrush>
                                            </Setter.Value>
                                        </Setter>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </TextBox.Style>
                    </TextBox>
                    
                    <!-- Command List -->
                    <ListBox Grid.Row="2" 
                             ItemsSource="{Binding Commands}"
                             SelectedItem="{Binding SelectedCommand}"
                             ItemTemplate="{StaticResource CommandCardTemplate}"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                             Background="Transparent"
                             BorderThickness="0">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <ContentPresenter/>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                    </ListBox>
                </Grid>
            </Border>
            
            <!-- Splitter -->
            <GridSplitter x:Name="LogsSplitter" Grid.Row="1" Height="4" HorizontalAlignment="Stretch" 
                          VerticalAlignment="Center" Background="Transparent" ResizeBehavior="PreviousAndNext"/>
            
            <!-- Bottom Panel - Logs -->
            <Border x:Name="LogsSection" Grid.Row="2" 
                    Background="{StaticResource SurfaceBrush}" 
                    CornerRadius="8" Padding="8">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <Grid Grid.Row="0" Margin="0,0,0,8">
                        <TextBlock Text="📋 Logs" 
                                   Foreground="{StaticResource TextPrimaryBrush}"
                                   FontSize="14" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <Button Content="🗑 Clear" 
                                Style="{StaticResource SecondaryButton}"
                                Command="{Binding ClearLogsCommand}"
                                HorizontalAlignment="Right"
                                Padding="8,2" FontSize="11"/>
                    </Grid>
                    
                    <ListBox x:Name="LogList"
                             Grid.Row="1"
                             ItemsSource="{Binding Logs}"
                             ItemTemplate="{StaticResource LogEntryTemplate}"
                             Background="Transparent"
                             BorderThickness="0"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="Focusable" Value="False"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <ContentPresenter/>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                    </ListBox>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>
